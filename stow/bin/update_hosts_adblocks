#!/usr/bin/env bash

# todo - backup hosts file before overwritting. Display where you put it.

set -euo pipefail

if [ "$(id -u)" != "0" ]
then
  echo "Only root can do this"
  exit 1
fi


surl="https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts"
hosts="/tmp/the-hosts"
downloaded="/tmp/hosts.downloaded"
tmp="/tmp/hosts.tmp"
mark_begin="# adblocking begin #"
mark_end="# adblocking end #"

echo "still WIP. run: cp /etc/hosts ${hosts}; sudo $(basename $0)"
exit 3

function truncateHosts {
  local lb le
  if ! grep -q "$mark_begin" "$hosts"
  then
    return 0
  fi
  lb=$(grep -ne "$mark_begin" "$hosts" | head -n 1 | awk -F: '{print $1}')
  le=$(grep -ne "$mark_end" "$hosts" | head -n 1 | awk -F: '{print $1}')
  sed "$lb,$le d" "$hosts" > "$tmp"
  tee "$hosts" < "$tmp"

  return 0
}

function markStart {
  echo "$mark_begin" | tee -a "$hosts"
}

function markEnd {
  echo "$mark_end" | tee -a "$hosts"
}

function downloadHosts {
  rm -f "$downloaded"
  curl -o "$downloaded" "$surl"
}

function insertHosts {
 tee -a "$hosts" < "$downloaded"
}

downloadHosts
truncateHosts
markStart
insertHosts
markEnd

echo "I'm done"
