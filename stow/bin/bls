#!/usr/bin/env bash

set -euo pipefail

. "$(dirname "$0")"/.lib

VERSION="1.0"
BLS_CACHE_PATH="$HOME/.local/share/bls"
BLS_CACHE_CASKS="${BLS_CACHE_PATH}/casks.json"
BLS_CACHE_FORMULA="${BLS_CACHE_PATH}/formula.json"
BLS_CACHE_OFFSET="7 days ago"
BLS_CACHE_LAST_MODIFIED="just now"
_skip_update=0

# ------------------------------------------------------------
# CACHING
# ------------------------------------------------------------
function _validateCache {
  # check modification timestamps
  if [ ! -f "$BLS_CACHE_CASKS" ] || [[ ! $(find "$BLS_CACHE_CASKS" -newermt "$BLS_CACHE_OFFSET") ]] 
  then
    ealert "Cache outdated. Updating..."
    updateCache
  fi
  BLS_CACHE_LAST_MODIFIED=$(date -r "$BLS_CACHE_CASKS" -u "+%Y-%m-%d %H:%M")
}

function deleteCache {
  if [ -d "$BLS_CACHE_PATH" ]
  then
    rm -rf "$BLS_CACHE_PATH"
  fi
}

function updateCache {
  if [ "$_skip_update" == 1 ]; then return 0; fi
  # create cache dir
  if [ ! -d "$BLS_CACHE_PATH" ]
  then
    mkdir -p "$BLS_CACHE_PATH"
  fi
  # cache important files
  einfo -n "Downloading casks definitions"
  curl -s https://formulae.brew.sh/api/cask.json > "$BLS_CACHE_CASKS"
  eok "done"
  einfo -n "Downloading formulae definitions"
  curl -s https://formulae.brew.sh/api/formula.json > "$BLS_CACHE_FORMULA"
  eok "done"
  _skip_update=1
}

# ------------------------------------------------------------
# PRIVATE
# ------------------------------------------------------------

function __is_it_cask {
  if [[ "$1" == *" --cask"* ]]; then
    echo "yes"
  else
    echo "no"
  fi
}

function __strip_internal_cask {
  echo "$1" | sed -E 's/ \-\-cask//g'
}

function __name_to_token {
  if [[ "$1" == *" --cask"* ]]; then
    name=$(__strip_internal_cask "$1")
    jq '.[] | select(.name[0]=="'"$name"'") | .token' <"$BLS_CACHE_CASKS" | sed -E 's/"//g'
  else
    echo "$1"
  fi
}

function fzf_preview {
  local name token
  name="$2"
  token=$name
  ebox "$name"
  if [[ "$name" == *" --cask"* ]]; then
    token=$(__name_to_token "$name")
    brew info --cask "$token"
  else
    brew info "$name"
  fi
}

function __list_formulae {
  jq '.[] | .full_name' <"$BLS_CACHE_FORMULA" | sed -E 's/"//g'
}

function __list_casks {
  local marker
  marker=${1:-""}
  jq '.[] | .name[0]' <"$BLS_CACHE_CASKS" | sed -E 's/"//g' | sed -E "s/$/ $marker/g"
}

# ------------------------------------------------------------
# PUBLIC interfaces
# ------------------------------------------------------------

function list_all {
  local casks formulae list
  casks=$(__list_casks "--cask")
  formulae=$(__list_formulae)
  list=("${casks[@]}" "${formulae[@]}")

  query=${1:-""}

  echo "${list[@]}" | \
    fzf -q "$query" \
    --header "CTRL+i : install; updated: ${BLS_CACHE_LAST_MODIFIED}" \
    --scroll-off 2 \
    --prompt "brew >> " \
    --bind "ctrl-i:select+preview(bls --install {})" \
    --preview-window "right,70%" \
    --preview="${BASH_SOURCE[0]} --preview {}"
}

function __install {
  picked="$*"
  name=$(__strip_internal_cask "$picked")
  token=$picked
  if [ "$(__is_it_cask "$picked")" == "yes" ]; then
    token=$(__name_to_token "$picked")
  fi
  ebox "Installing '$token'"
  ec=0
  brew install "$token" || ec=$?
  if [ "$ec" -eq 0 ]; then
    echo ""
    eok "done"
  else
    echo ""
    efail "nope, sorry. â†‘ exited with: $ec"
  fi
}

function __install_questions {
  picked="$*"
  name=$(__strip_internal_cask "$picked")
  token=$picked
  question="Install '$name'? "
  if [ "$(__is_it_cask "$picked")" == "yes" ]; then
    token=$(__name_to_token "$picked")
    question="Install cask '$name'? "
  fi
  echo -n "$question [N/y] "
  read -rsn1 resp
  echo ""
  if [ "$resp" == "y" ] || [ "$resp" == "Y" ]; then
    echo "Installing '$token'"
    brew install "$token"
  fi
}

function help {
  echo "$(basename "$0") <options> name
version $VERSION

Options:
  --help     This help message
  --version  Display the version number (it is $VERSION)
  --update   Force update the local cask and formula repositories
  --clean    Purge any cached files

Examples:
  Force update and pre-fill ncd in the query
  $(basename "$0") --update ncd
"
}
# ------------------------------------------------------------
# ROUTER
# ------------------------------------------------------------

while [[ -n ${1:--help} ]]; do
  case ${1:--help} in
    --update )
      updateCache
      shift
      list_all "$@"
      exit 0
      ;;

    --clean )
      einfo "Clearning bls databases"
      deleteCache
      eok "done"
      exit 0
      ;;

    --preview )
      fzf_preview "$@"
      shift
      exit 0
      ;;

    --install )
      shift
      __install "$@"
      exit 0
      ;;

    --version )
      echo "version: $VERSION"
      exit 0
      ;;

    --help )
      help
      exit 0
      ;;

    *)
      _validateCache
      list_all "$@"
      shift
      exit 0
      ;;
  esac
  shift
done
